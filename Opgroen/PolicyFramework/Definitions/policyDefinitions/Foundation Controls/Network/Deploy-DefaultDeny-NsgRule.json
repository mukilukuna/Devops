{
    "name": "Deploy-DefaultDeny-NsgRule",
    "properties": {
      "Description": "Enforce network security groups to have a default DENY Virtualnetwork-VirtualNetwork security rule.",
      "Metadata": {
        "Version": "1.0.0",
        "Category": "Network Security"
      },
      "DisplayName": "Network: Enforce network security groups to have a default DENY Virtualnetwork-VirtualNetwork security rule.",
      "Mode": "All",
      "Parameters": {
        "effect": {
          "type": "String",
          "metadata": {
            "displayName": "Effect",
            "description": "Enable or disable the execution of the policy"
          },
          "allowedValues": [
            "Disabled",
            "DeployIfNotExists"
          ],
          "defaultValue": "DeployIfNotExists"
        },
        "priority": {
          "type": "Integer",
          "metadata": {
            "displayName": "priority",
            "description": "Priority for the deny VirtualNetwork-VirtualNetwork security rule (Example 100)."
          },
          "defaultValue": 4096
        }
      },
      "PolicyRule": {
        "if": {
          "field": "type",
          "equals": "Microsoft.Network/networkSecurityGroups"
        },
        "then": {
          "effect": "[parameters('effect')]",
          "details": {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "roleDefinitionIds": [
              "/providers/Microsoft.Authorization/roleDefinitions/4d97b98b-1d4f-4787-a291-c67834d212e7"
            ],
            "existenceCondition": {
              "allof": [
                {
                  "field": "Microsoft.Network/networkSecurityGroups/securityRules/access",
                  "equals": "Deny"
                },
                {
                  "field": "Microsoft.Network/networkSecurityGroups/securityRules/direction",
                  "equals": "Inbound"
                },
                {
                  "field": "Microsoft.Network/networkSecurityGroups/securityRules/sourceAddressPrefix",
                  "equals": "*"
                },
                {
                  "field": "Microsoft.Network/networkSecurityGroups/securityRules/destinationAddressPrefix",
                  "equals": "*"
                },
                {
                  "field": "Microsoft.Network/networkSecurityGroups/securityRules/priority",
                  "equals": "[parameters('priority')]"
                }
              ]
            },
            "deployment": {
              "properties": {
                "mode": "incremental",
                "parameters": {
                  "nsgName": {
                    "value": "[field('name')]"
                  },
                  "priority": {
                    "value": "[parameters('priority')]"
                  }
                },
                "template": {
                  "$schema": "http://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "parameters": {
                    "nsgName": {
                      "type": "string"
                    },
                    "priority": {
                      "type": "int"
                    }
                  },
                  "resources": [
                    {
                      "name": "[concat(parameters('nsgName'),'/Deny-VirtualNetwork-VirtualNetwork-Traffic')]",
                      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                      "apiVersion": "2019-11-01",
                      "properties": {
                        "description": "Default deny VirtualNetwork to VirtualNetwork traffic to ensure zero trust model",
                        "protocol": "*",
                        "sourcePortRange": "*",
                        "destinationPortRange": "*",
                        "sourceAddressPrefix": "VirtualNetwork",
                        "destinationAddressPrefix": "VirtualNetwork",
                        "access": "Deny",
                        "priority": "[parameters('priority')]",
                        "direction": "Inbound",
                        "sourcePortRanges": [],
                        "destinationPortRanges": [],
                        "sourceAddressPrefixes": [],
                        "destinationAddressPrefixes": []
                      }
                    }
                  ]
                }
              }
            }
          }
        }
      }
    }
  }
  