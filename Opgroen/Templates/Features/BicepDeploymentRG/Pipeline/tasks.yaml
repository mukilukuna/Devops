parameters:
  - name: subscriptionId
    type: string
  - name: resourceGroupName
    type: string
  - name: azureResourceManagerConnection
    type: string
  - name: location
    type: string
  - name: targetFiles
    type: string
  - name: csmFile
    type: string
  - name: csmParametersFile
    type: string
    default: ""
  - name: overrideParameters
    type: string
    default: ""
  - name: deploymentMode
    type: string
    default: "Incremental"
  - name: templateRepo
    type: string
  - name: templateProject
    type: string
  - name: version
    type: string
  - name: templateFileName
    type: string
    default: template.bicep
  - name: outPutPrefix
    type: string
    default: ""

steps:
  - ${{ if and(ne(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.SourceBranch'], 'refs/heads/staging')) }}:
      - checkout: self
      - checkout: git://${{ parameters.templateProject }}/${{ parameters.templateRepo }}@refs/tags/${{ parameters.version }}
      - task: qetza.replacetokens.replacetokens-task.replacetokens@6
        displayName: Replace tokens
        inputs: # https://github.com/qetza/replacetokens-task/blob/main/tasks/ReplaceTokensV6/README.md#inputs
          sources: ${{ parameters.targetFiles }}
          ifNoFilesFound: "warn"
          missingVarAction: keep
          missingVarLog: error
          telemetryOptout: true
          tokenPattern: "custom"
          tokenPrefix: "*<"
          tokenSuffix: ">*"
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: "BicepDeploymentValidation"
        name: "BicepDeploymentValidation"
        inputs:
          deploymentScope: "Resource Group"
          deploymentMode: "Validation"
          action: "Create Or Update Resource Group"
          resourceGroupName: ${{ parameters.resourceGroupName }}
          azureResourceManagerConnection: ${{ parameters.azureResourceManagerConnection }}
          subscriptionId: ${{ parameters.subscriptionId }}
          location: ${{ parameters.location }}
          csmFile: /$(System.DefaultWorkingDirectory)/$(Build.Repository.Name)${{ parameters.csmFile }}
          csmParametersFile: ${{ parameters.csmParametersFile }}
          overrideParameters: ${{ parameters.overrideParameters }}
          deploymentOutputs: armOutputs

  - ${{ if or(eq(variables['Build.SourceBranch'], 'refs/heads/main'),eq(variables['Build.SourceBranch'], 'refs/heads/staging')) }}:
      - checkout: self
      - checkout: git://${{ parameters.templateProject }}/${{ parameters.templateRepo }}@refs/tags/${{ parameters.version }}
      - task: qetza.replacetokens.replacetokens-task.replacetokens@6
        displayName: Replace tokens
        inputs: # https://github.com/qetza/replacetokens-task/blob/main/tasks/ReplaceTokensV6/README.md#inputs
          sources: ${{ parameters.targetFiles }}
          ifNoFilesFound: "warn"
          missingVarAction: keep
          missingVarLog: error
          telemetryOptout: true
          tokenPattern: "custom"
          tokenPrefix: "*<"
          tokenSuffix: ">*"
      - task: AzureResourceManagerTemplateDeployment@3
        displayName: "BicepDeployment"
        name: "BicepDeployment"
        inputs:
          deploymentScope: "Resource Group"
          deploymentMode: ${{ parameters.deploymentMode }}
          action: "Create Or Update Resource Group"
          resourceGroupName: ${{ parameters.resourceGroupName }}
          azureResourceManagerConnection: ${{ parameters.azureResourceManagerConnection }}
          subscriptionId: ${{ parameters.subscriptionId }}
          location: ${{ parameters.location }}
          csmFile: /$(System.DefaultWorkingDirectory)/$(Build.Repository.Name)${{ parameters.csmFile }}
          csmParametersFile: ${{ parameters.csmParametersFile }}
          overrideParameters: ${{ parameters.overrideParameters }}
          deploymentOutputs: armOutputs
