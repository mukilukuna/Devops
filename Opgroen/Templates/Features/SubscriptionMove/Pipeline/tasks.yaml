parameters:
  - name: managementGroupId
    type: string
  - name: azureResourceManagerConnection
    type: string
  - name: location
    type: string
  - name: csmParametersFile
    type: string
  - name: templateRepo
    type: string
  - name: templateProject
    type: string
  - name: version
    type: string
  - name: templateFileName
    type: string
    default: template.bicep
  - name: outPutPrefix
    type: string
    default: ''
  - name: subscriptionId
    type: string
    default: ""
  - name: subscriptionName
    type: string
    default: ""

steps:
  - ${{ if and(ne(variables['Build.SourceBranch'], 'refs/heads/main'), ne(variables['Build.SourceBranch'], 'refs/heads/staging')) }}:
      - checkout: self
      - checkout: git://${{ parameters.templateProject }}/${{ parameters.templateRepo }}@refs/tags/${{ parameters.version }}
      - template: /.Global/Pipelines/validate.yaml
        parameters:
          templateRepo: ${{ parameters.templateRepo }}
          templateFileName: ${{ parameters.templateFileName }}
          workloadName: SubscriptionMove
          workloadType: Features
          managementGroupId: ${{ parameters.managementGroupId }}
          azureSubscription: ${{ parameters.azureResourceManagerConnection }}
          location: ${{ parameters.location }}
          parametersPath: ${{ parameters.csmParametersFile }}

  - ${{ if or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/staging')) }}:
      - checkout: self
      - checkout: git://${{ parameters.templateProject }}/${{ parameters.templateRepo }}@refs/tags/${{ parameters.version }}
      - template: /.Global/Pipelines/deploy.yaml
        parameters:
          outPutPrefix: ${{ parameters.outPutPrefix }}
          templateRepo: ${{ parameters.templateRepo }}
          templateFileName: ${{ parameters.templateFileName }}
          workloadName: SubscriptionMove
          workloadType: Features
          managementGroupId: ${{ parameters.managementGroupId }}
          azureSubscription: ${{ parameters.azureResourceManagerConnection }}
          location: ${{ parameters.location }}
          parametersPath: ${{ parameters.csmParametersFile }}

      - task: AzureCLI@2
        name: PsSetSubscriptionName
        displayName: "Azure CLI  script: Set Subscription Name"
        inputs:
          azureSubscription: $(azureResourceManagerConnection)
          scriptType: pscore
          scriptLocation: "scriptPath"
          scriptPath: "${{ parameters.templateRepo }}/Features/SubscriptionMove/Scripts/Set-AzSubscriptionName.ps1"
          arguments: -SubscriptionId '${{ parameters.subscriptionId }}'
            -SubscriptionName '${{ parameters.subscriptionName }}'
        condition: and(ne('${{ parameters.subscriptionId }}', ''), ne('${{ parameters.subscriptionName }}', ''))
