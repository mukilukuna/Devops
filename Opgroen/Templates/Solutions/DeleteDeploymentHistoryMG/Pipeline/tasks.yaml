parameters:
  - name: managementGroupId
    type: string
  - name: azureResourceManagerConnection
    type: string
  - name: numberOfDaysToKeep
    type: number
    default: 90
  - name: lowerLimit
    type: number
    default: 400
  - name: upperLimit
    type: number
    default: 800
  - name: templateRepo
    type: string
  - name: templateProject
    type: string
  - name: version
    type: string

steps:
  - ${{ if or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.SourceBranch'], 'refs/heads/staging')) }}:
      - checkout: self
      - checkout: git://${{ parameters.templateProject }}/${{ parameters.templateRepo }}@refs/tags/${{ parameters.version }}
      - task: AzurePowerShell@5
        displayName: 'Start MG Deployment History Cleanup'
        inputs:
          azureSubscription: ${{ parameters.azureResourceManagerConnection }}
          ScriptType: 'FilePath'
          ScriptPath: '$(System.DefaultWorkingDirectory)/${{ parameters.templateRepo }}/Solutions/DeleteDeploymentHistoryMG/Scripts/Start-DeleteDeploymentHistoryMG.ps1'
          ScriptArguments: '-ManagementGroupId "${{ parameters.managementGroupId }}" -NumberOfDaysToKeep ${{ parameters.numberOfDaysToKeep }} -LowerLimit ${{ parameters.lowerLimit }} -UpperLimit ${{ parameters.upperLimit }}'
          azurePowerShellVersion: 'LatestVersion'
          pwsh: true
